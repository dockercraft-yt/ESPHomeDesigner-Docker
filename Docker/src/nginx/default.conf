server {
    listen 80;
    # Accept any Host header from reverse proxy
    server_name _;

    # If an upstream reverse proxy already terminates TLS it should set
    # `X-Forwarded-Proto: https`. In that case we do NOT redirect again.
    # Otherwise redirect to HTTPS so direct access remains secure.
    if ($http_x_forwarded_proto = "") {
        return 301 https://$host$request_uri;
    }
    # Always configure the webroot so requests forwarded by a reverse proxy
    # (which set X-Forwarded-Proto) are served instead of falling back to a
    # directory index which may return 403.
    root /usr/share/nginx/html;
    index editor.html;

    location = / {
        try_files /editor.html =404;
    }

    location / {
        try_files $uri $uri/ /editor.html;
    }

    # When a reverse proxy forwards requests (and sets X-Forwarded-Proto),
    # the location handlers above will serve the SPA. Do not duplicate
    # root/index directives here.
}

# HTTPS server block - requires certificate and key at /etc/nginx/ssl/
server {
    listen 443 ssl http2;
    server_name localhost;

    ssl_certificate /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    root /usr/share/nginx/html;
    index editor.html;

    # Basic security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-Content-Type-Options nosniff;

    # Serve the SPA. Explicitly serve `editor.html` for the root path to avoid
    # directory-index behavior (which can return 403 when nginx can't find an
    # index file or is asked to list a directory).
    location = / {
        try_files /editor.html =404;
    }

    # Serve other files; fall back to editor.html for client-side routing.
    location / {
        try_files $uri $uri/ /editor.html;
    }

    error_log /var/log/nginx/error.log warn;
    access_log /var/log/nginx/access.log;
}

# If no certificates are provided, the HTTP block above will still redirect
# to HTTPS; mount or generate certs into `/etc/nginx/ssl/server.crt` and
# `/etc/nginx/ssl/server.key` inside the container to enable TLS.
